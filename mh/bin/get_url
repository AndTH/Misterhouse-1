#!/usr/bin/perl
# -*- Perl -*-

use strict;
                                # Point to mh LWP, in case local perl does not have it installed
my ($Pgm_Path, $Pgm_Name);
BEGIN {
    ($Pgm_Path, $Pgm_Name) = $0 =~ /(.*)[\\\/](.*)\.?/;
    ($Pgm_Name) = $0 =~ /([^.]+)/, $Pgm_Path = '.' unless $Pgm_Name;
    eval "use lib '$Pgm_Path/../lib', '$Pgm_Path/../lib/site'"; # So perl2exe works
}

my $url  = shift;
if (!$url or $url =~ /^-h/) {
    print<<eof;

    $Pgm_Name gets a web page and echos it to STDOUT or a local file.

Usage:

    $Pgm_Name url [local_file]

    If local_file is specified, data is stored there, otherwise
    it is echoed to STDOUT.


eof
    exit;
}

$url = 'http://' . $url unless $url =~ /^(\S+):\/\//;

                                # Get parms from mh.ini
require 'handy_utilities.pl';
my %config_parms;
&main::read_mh_opts(\%config_parms, $Pgm_Path);

                                # Allow for this ... get_url > $file is better/safer, but
                                # background processes in windows really messes up with > :(
my $file = shift;

if ($config_parms{get_url} eq 'useragent') {
    &use_ua;                    # This fails for some people.  Required if using a proxy
}
else {
    &use_get;                   # The simple get does not have a timeout :(
}

sub use_ua {
    use LWP::UserAgent;
#   use HTTP::Request;
#   use HTTP::Response;
#   require LWP::UserAgent;

    my $ua = new LWP::UserAgent;

    $ua->timeout([120]);         # Time out after 60 seconds 
    $ua->env_proxy(); 

    my $request = new HTTP::Request('GET', $url);
    my $response;
    if ($file) {
        print "Retrieving (with ua) $url into $file ...";
        $response = $ua->simple_request($request, $file);
        print " url retreived.\n";
        exit;
    }
    else {
        $response = $ua->simple_request($request);
        print $response->content();
    }
    if ($response->is_error()) {
        printf " %s\n", $response->status_line;
    }
}

sub use_get {
    use LWP::Simple;
    if ($file) {
        print "Retrieving (with simple) $url into $file ...";
        
        # Do not use simple get ... it will not time out :(
        my $data = get $url;

        if ($data) {
            open (OUT, ">$file") or die "Error, could not open file $file for output\n";
            print OUT $data;
            close OUT;
            print " url retreived\n";
        }
        else {
            print " get failed\n";
        }
    }
    else {
        print "db $url\n";
        print get $url;
    }
}

#
# $Log$
# Revision 1.7  2000/11/12 21:01:02  winter
# - 2.34 release
#
# Revision 1.6  2000/01/27 13:23:18  winter
# - update version number
#
# Revision 1.5  1999/07/05 22:30:50  winter
# - check for help request
#
# Revision 1.4  1999/06/20 22:30:41  winter
# *** empty log message ***
#
# Revision 1.3  1999/03/12 04:35:48  winter
# - add proxy.
#
# Revision 1.2  1999/02/26 14:30:27  winter
# - use UserAgent so we can time out
#
# Revision 1.1  1999/02/21 00:29:49  winter
# - created
#
#

