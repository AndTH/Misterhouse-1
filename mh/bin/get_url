#!/usr/bin/perl
# -*- Perl -*-

use strict;
                                # Point to mh LWP, in case local perl does not have it installed
my ($Pgm_Path, $Pgm_Name);
BEGIN {
    ($Pgm_Path, $Pgm_Name) = $0 =~ /(.*)[\\\/](.*)\.?/;
    ($Pgm_Name) = $0 =~ /([^.]+)/, $Pgm_Path = '.' unless $Pgm_Name;
    eval "use lib '$Pgm_Path/../lib', '$Pgm_Path/../lib/site'"; # So perl2exe works
}

my %config_parms;

my $url  = shift;
if ($url eq '-quiet') {
    $url  = shift;
    $config_parms{quiet}++;
}

if (!$url or $url =~ /^-h/) {
    print<<eof;

    $Pgm_Name gets a web page and echos it to STDOUT or a local file.

Usage:

    $Pgm_Name [-quiet] url [local_file]

    If local_file is specified, data is stored there.
    if local_file = /dev/null, data is not returned.
    Otherwise, data is echoed to STDOUT.


eof
    exit;
}

$url = 'http://' . $url unless $url =~ /^(\S+):\/\//;

                                # Get parms from mh.ini
require 'handy_utilities.pl';
&main::read_mh_opts(\%config_parms, $Pgm_Path);

                                # Allow for this ... get_url > $file is better/safer, but
                                # background processes in windows really messes up with > :(
my $file = shift;

if ($config_parms{get_url} eq 'useragent') {
    &use_ua;                    # This fails for some people.  Required if using a proxy
}
else {
    &use_get;                   # The simple get does not have a timeout :(
}

sub use_ua {
    use LWP::UserAgent;
#   use HTTP::Request;
#   use HTTP::Response;
#   require LWP::UserAgent;

    my $ua = new LWP::UserAgent;
    $config_parms{proxy} = $ENV{HTTP_PROXY}           unless $config_parms{proxy};
    $ua -> proxy(['http', 'ftp'] => $config_parms{proxy}) if $config_parms{proxy};

    $ua->timeout([120]);         # Time out after 60 seconds 
    $ua->env_proxy();
    $ua->agent($config_parms{get_url_ua}) if $config_parms{get_url_ua};

    my $request = new HTTP::Request('GET', $url);
    my $response;
    
    if ($file) {
        print "Retrieving (with ua) $url into $file ..." unless $config_parms{quiet};
        if ($file eq '/dev/null') {
            $response = $ua->request($request);
        }
        else {
            $response = $ua->request($request, $file);
        }
        print " url retrieved.\n" unless $config_parms{quiet};
        exit;
    }
    else {
        $response = $ua->request($request);
        print $response->content();
    }
    if ($response->is_error()) {
        printf " %s\n", $response->status_line;
    }
}

sub use_get {
    use LWP::Simple;
    if ($file) {
        print "Retrieving (with simple) $url into $file ..." unless $config_parms{quiet};
        
        # Do not use simple get ... it will not time out :(
        my $data = get $url;
#       print $data;
        unless ($file eq '/dev/null') {
            if ($data) {
                open (OUT, ">$file") or die "Error, could not open file $file for output\n";
                print OUT $data;
                close OUT;
                print " url retrieved\n" unless $config_parms{quiet};
            }
            else {
                print " get failed\n";
            }
        }
    }
    else {
        print get $url;
    }
}

#
# $Log$
# Revision 1.13  2002/08/22 04:33:18  winter
# - 2.70 release
#
# Revision 1.12  2002/03/02 02:36:49  winter
# - 2.65 release
#
# Revision 1.11  2002/01/23 01:50:33  winter
# - 2.64 release
#
# Revision 1.10  2002/01/19 21:11:09  winter
# - 2.63 release
#
# Revision 1.9  2001/02/04 20:31:30  winter
# - 2.43 release
#
# Revision 1.8  2000/12/21 18:54:14  winter
# - 2.38 release
#
# Revision 1.7  2000/11/12 21:01:02  winter
# - 2.34 release
#
# Revision 1.6  2000/01/27 13:23:18  winter
# - update version number
#
# Revision 1.5  1999/07/05 22:30:50  winter
# - check for help request
#
# Revision 1.4  1999/06/20 22:30:41  winter
# *** empty log message ***
#
# Revision 1.3  1999/03/12 04:35:48  winter
# - add proxy.
#
# Revision 1.2  1999/02/26 14:30:27  winter
# - use UserAgent so we can time out
#
# Revision 1.1  1999/02/21 00:29:49  winter
# - created
#
#

